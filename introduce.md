### 设计背景
公司要选型是否续费办公区宽带，需要知道办公区宽带的实际情况。

现在能够确定的是下行100Mbps足够使用的，但尚不知上行带宽是否够用。

### 程序任务
在规定的时间范围内，每隔一段时间测量办公区的上下行带宽、时延及丢包率，并将数据存储下来。

### 大体思路
1. **测量时延**
   
   在平时，测量时延与丢包率的方式是 **ping** 一个网站，通过类似于 `ping -c 50 www.baidu.com` 的命令获取相关信息。

   正因为如此，我一开始时打算使用Python的ping模块来完成此项任务，但在用Macbook执行 `pip install ping` 时提示源文件有语法错误。

   受限于电脑的权限，我无法更改pip下载得到的源文件，为了能节省时间，我最后通过使用 `os.popen(command)` **调用外部命令** 的方式，间接调用 `ping` 命令，这也成为后面测量带宽的方式。

2. **测量上下行带宽**

   通过上网查找相关资料，我准备使用程序 **speedtest** 测量上下行带宽

### speedtest简介

Speedtest.net是Ookla的一个强大而知名的全球宽带网络速度测试网站，具有很高的Alexa世界排名。作为一款在线并且可视化的网速测试工具，它的使用方法简单，无需下载安装多余软件，只需有浏览器即可。

speedtest-cli正是其对应的 **终端** 上测试工具。它是一个使用Python编写的命令行脚本，在执行过程中，它会查询所有可用的服务器，然后默认选择距离最近的一个，通过向其发送和接收数据，获取上下行带宽。当然，用于帮助测试的服务器也可以被专门指定。

* 安装方法
  ```
  pip install speedtest-cli
  ```
* 使用方法

  安装完成后在终端执行命令 `speedtest` 即可

### 实现方式

设计了一个 **TestNet类**，在调用时只需要调用其实例的 `run(target_file)` 即可。
> 这里的target_file必须是 **md** 文件，因为数据最终会在md文件中以表格的形式呈现出来。

该类主要完成三项任务：**计时**、**获取数据**、**写入文件**。
> 在获取数据并写入数据的过程中，如果发生网络中断等异常，会终止当前任务，并等待下一个time_order。

1. **计时**

   这里的目标是，在指定的 **start_time** 与 **end_time** 范围内，每隔指定的 **interval** 就获取一次数据。可以在 **start_end.conf** 中设置start_time与end_time，格式应与time的asctime一致。我采用的计时方式是：
   > **设置** 一个time_order，在一个循环中，如果当前时间大于该量并小于end_time，则将该量 **增加** 一个interval，然后获取数据并写入文件；否则跳出循环，此时程序执行完毕。
   > 
   > time_order被初始化为start_time

2. **获取数据**

   这里又分为两种数据，ping到的 **时延丢包率**、speedtest到的 **上下行带宽**。
   1. **时延**（rt）和 **丢包率**（pl）
      
      默认ping百度。

      执行 `ping -c 50 www.baidu.com` 后，程序返回信息的最后两行是：
      > 50 packets transmitted, 50 packets received, 0.0% packet loss
      >
      > round-trip min/avg/max/stddev = 5.279/5.736/6.277/0.412 ms

      这里面**avg**与**packet loss**对应的值是我所需要的，为此，在通过
      ```
      rtn = [p for p in os.popen('ping -c 50 www.baidu.com')]
      ```
      获取最后两行的字符串信息之后，通过字符串切片的方式获取了相应的值。

   2. **上行带宽**（up）和 **下行带宽**（dn）
   
      基本思路同上，但我所需要的数据出现在rtn的下标1、4、6、8处。

      此外我还特意获取了被测试的IP地址（tf）、服务器到该IP机器处的距离（hb）、测试时间（tm）。
3. **写入文件**

   首先为文件写入表头并保存：
   ```
   |test time|test from|hosted from|download|upload|round trip|packet loss|
   |----|----|----|----|----|----|----|
   ```
   然后将获取的数据拼接成一个字符串，该字符串符合markdown的表格语法。再将该字符串追加到文件下一行，并保存。

在程序完成后，我测试了从中午12:00到第二天中午12:00的宽带数据，测得的上行带宽大部分时间集中的80Mbit/s上，下行带宽与其相差不多，而时延除了在15:00到15:30之间偶尔上升到10ms，其余时间基本集中在6ms左右，而丢包率基本为零，这说明当前网络的质量不错，而且上行宽带暂时满足需求。另外，测得的数据也说明，网络质量的不稳定会同时影响时延、丢包率以及上下行带宽。
